<!DOCTYPE html>
<html>
  <head>
    <title>Wanderstreets</title>
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="leaflet/leaflet.ie.css" />
    <![endif]-->
    <script src="leaflet/leaflet.js"></script>

  </head>
  <body style="padding: 0; margin: 0;">

    <div id="map" style="height: 100%; margin: 0;"></div>

    <div style="left: 50%; top: 50%; width: 10px; height: 10px; background-color: black; z-index: 2; position: absolute; border-radius: 5px;">.</div>

    <script>
        var map = new L.Map('map', {
          zoomControl: false,
          dragging: false,
          touchZoom: false,
          scrollWheelZoom: false,
          doubleClickZoom: false
        });

        var tiles_url = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png';

        var attribution = 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade';

        var map_layer = new L.TileLayer(tiles_url, {maxZoom: 18, attribution: attribution});

        map.setView(new L.LatLng(50, -1), 16).addLayer(map_layer);

        var way_id = 39594610;
        var node_number = 1;

        xmlhttp=new XMLHttpRequest();
        xmlhttp.open("GET","http://www.openstreetmap.org/api/0.6/way/" + way_id,false);
        xmlhttp.send();
        xmlDoc=xmlhttp.responseXML;

        var nodes_count = xmlDoc.getElementsByTagName("nd").length;
        var node_id = xmlDoc.getElementsByTagName("nd")[node_number].getAttribute("ref");

        var t = setTimeout("move()", 250);

        function move() {

          var node_id = xmlDoc.getElementsByTagName("nd")[node_number].getAttribute("ref");
          console.log("On node " + node_number + " of " + nodes_count + " (" + node_id + " on way " + way_id + ")");

          var node_request = new XMLHttpRequest();

          var node_url = "http://www.openstreetmap.org/api/0.6/node/" + node_id;
          node_request.open("GET", node_url,false);
          node_request.send();
          nodeXml = node_request.responseXML;

          var new_lat = nodeXml.getElementsByTagName("node")[0].getAttribute("lat");
          var new_lon = nodeXml.getElementsByTagName("node")[0].getAttribute("lon");

          node_number = node_number + 1;

          map.panTo(new L.LatLng(new_lat, new_lon));

          if (node_number >= nodes_count) {

            console.log("looking for a new way to switch to");

            var otherWaysRequest = new XMLHttpRequest();

            var other_ways_url = "http://www.openstreetmap.org/api/0.6/node/" + node_id + "/ways";
            otherWaysRequest.open("GET", other_ways_url,false);
            otherWaysRequest.send();
            var otherWaysXml = otherWaysRequest.responseXML;

            var waysCount = otherWaysXml.getElementsByTagName("ways").length;

            var first_way_id = otherWaysXml.getElementsByTagName("way")[0].getAttribute("id");

            if (parseInt(first_way_id) == way_id) {
              console.log("first node is existing one. Trying second.");
              way_id = otherWaysXml.getElementsByTagName("way")[1].getAttribute("id");
            } else {
              way_id = first_way_id;
            }
              node_number = 1;
              console.log("switching to way " + way_id);
              xmlhttp=new XMLHttpRequest();

              var way_url ="http://www.openstreetmap.org/api/0.6/way/" + way_id
              xmlhttp.open("GET", way_url, false);
              xmlhttp.send();
              xmlDoc=xmlhttp.responseXML;
              nodes_count = xmlDoc.getElementsByTagName("nd").length;

              var t = setTimeout("move()", 250);

          } else {
            var node_ref = xmlDoc.getElementsByTagName("nd")[node_number].getAttribute("ref");

            var t = setTimeout("move()", 250);
          }


        }

      </script>

  </body>
</html>
